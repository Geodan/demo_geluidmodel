<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="../bower_components/x3d-elements/x3d-viewer.html">
<link rel="import" href="../bower_components/x3d-elements/x3d-inlinelayer.html">


<dom-module id="main-app">
<style include="iron-flex iron-flex-alignment"></style> 
<style>
 paper-item {
 	 cursor: pointer;
 }
 paper-toolbar.white {
    --paper-toolbar-background: white;
    --paper-toolbar-title: {
      font-style: italic;
      font-weight: bold;
    };
    padding: 20px;
 }
 .title {
 	 margin-top: 10px; 
 }
 
 </style>
 <template>
 	<paper-drawer-panel id='menu'>
		<div drawer>
			<paper-toolbar class="medium-tall">
			<div class="title">X3D viewer</div>
			<paper-tabs  class="bottom" selected="{{tabselected}}">
				<paper-tab>Layers</paper-tab>
				<paper-tab>Scene</paper-tab>
			</paper-tabs>
			</paper-toolbar>
			
			<iron-pages selected=[[tabselected]]>
				<div>
					<template is='dom-repeat' items=[[layers]]>
						<paper-item>
							<paper-checkbox   on-change='layertoggle' checked=[[item.active]]>
									</paper-checkbox>
							<paper-item-body>
								<div class="layout horizontal">
									<span class='flex'>[[item.displayName]]</span>
									<paper-spinner active=[[item.loading]]></paper-spinner>
								</div>
							</paper-item-body>
							
						</paper-item>
					</template>
				</div>
				<div>
					 Nothing here...
				</div>
			</iron-pages>
			
		</div>
		<div main>
		<paper-header-panel class="flex">
			<paper-toolbar class="medium-tall white" justify='justified'>
			 	<span class='title'>
			 		<img src='../images/geodan.png' height='80px'>
			 	</span>
			</paper-toolbar>
			
			<x3d-viewer 
				 map={{map}} 
			>
			<!--
				 <inline id=roofplanes url="../data/roofs_lod2.x3d" load=true render=true> </inline> 
				 <inline id=roofoutline url="../data/roofoutline.x3d" load=true render=true> </inline>
			-->	
				<template is='dom-repeat' items=[[layers]]>
					<inline id=[[item.name]]> </inline>
					<x3d-inlinelayer 
						render=[[item.active]] 
						map=[[map]]
						on-loading='_loading'
						on-loaded='_loaded'
						url=[[item.url]] 
						name=[[item.name]]
						></x3d-inlinelayer>
				
				</template>
				
			</x3d-viewer>
		</paper-header-panel>
		</div>
	</paper-drawer-panel>
 	
 </template>
 </dom-module>

<script>

Polymer({
	is: 'main-app',
	properties: {
		tabselected: {
			type: Number,
			value: 0
		},
		selectedLayers: {
			type: Array
			//observer: '_selectedLayersChanged'
		},
		map: {
			type: Object,
			observer: '_mapChanged'
		},
		layers: {
			type: Array,
			value: function(){
				return [
					{name: 'roofplanes',displayName: 'Buildings LOD2', active: false, hidden: false,url: "./data/roofs_lod2.x3d"},
					{name: 'buildings',displayName: 'Buildings LOD1', active: true, hidden: false,url: "./data/roofs_lod1.x3d"},
					{name: 'roofoutline',displayName: 'Outline', active: true, hidden: false,url: "./data/roofoutline.x3d"},
					{name: 'water', 	displayName: 'Water', active: true, hidden: false,url: "./data/water.x3d"},
					/*
					{name: 'buildings',displayName: 'LOD1', active: false, hidden: false,url: servicepath},
					{name: 'buildup',displayName: 'Buildup', active: true, hidden: false,url: servicepath},
					
					{name: 'terrain', 	displayName: 'Terrein', active: false, hidden: false,url: servicepath},
					{name: 'roads', 	displayName: 'Wegen', active: false, hidden: false,url: servicepath},
					{name: 'treepoints',displayName: 'Bomen (punten)', active: false, hidden: false,url: servicepath},
					{name: 'buildingpoints',displayName: 'Panden (punten)', active: false, hidden: false,url: servicepath},
					{name: 'kade', 		displayName: 'Kade', active: false, hidden: false,url: servicepath},
					*/
				
				];
			}
			
		},
		
		
	},
	observers: [
	],
	_loading: function(a,b){
		var item = a.model.item;
		var idx = this.layers.indexOf(a.model.item);
		this.set('layers.'+idx+'.loading',true);
	},
	_loaded: function(a,b){
		var item = a.model.item;
		var idx = this.layers.indexOf(a.model.item);
		this.set('layers.'+idx+'.loading',false);
	},

	_isActive: function(item){
		return item.active;
	},
	_isnothidden: function(item){
		return !item.hidden;
	},
	layertoggle: function(e,d){
		var self = this;
		var status = e.target.checked;
		var layername = e.model.item.name;
		var layer = this.layers.forEach(function(l,i){
				if (l.name == layername){
					//var status = l.active?false:true; 
					self.set('layers.'+i+'.active',status);
					//l.active = status;
				}
		});
	},
	_mapChanged: function(map){
		this._flyTo([122480.60,489444.97],200); //Distelbuurt
	},

	_flyTo: function(coords,r){
		var radius = r || 100;
		var x = coords[0];
		var y = coords[1];
		var bbox = {
			west: x -radius,
			east: x +radius,
			south: y -radius,
			north: y +radius
		}
		var map = self.map;
		map.dim.minx = parseInt(bbox.west);
		map.dim.maxx = parseInt(bbox.east);
		map.dim.miny = parseInt(bbox.south);
		map.dim.maxy = parseInt(bbox.north);
		
		var tiles = map.bbox2tiles(map.dim.getBounds());
		document.querySelectorAll('x3d-layer').forEach(function(d){
			d.removeTiles();//TODO make nicer
			d.tiles = tiles;
		});
		
		map.scene.select("#viewpoint")
			.attr( "centerOfRotation", coords[0] + " " + coords[1] + " 0" )
			.attr( "position", coords[0] + " " + coords[1] + " 550")
			.attr('set_bind',true);
		
		document.getElementById('viewpoint').addEventListener('viewpointChanged', this.viewFunc, false);
	},
	
	ready: function(){
		var self = this;
		this.addEventListener('goto-rdcoords',function(d){
      		var coords = d.detail;
            self._flyTo(coords);
      	  });
      	
	}
});
</script>
